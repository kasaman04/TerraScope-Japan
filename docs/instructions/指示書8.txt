ğŸš€â€¯Stepâ€¯9â€¯â€”â€¯GA4 ï¼‹ Cookieâ€¯Consent ãƒãƒŠãƒ¼
ç›®çš„â€¯: è¨ˆæ¸¬ã‚’é–‹å§‹ã—ã¤ã¤ã€GDPRï¼æ”¹æ­£å€‹äººæƒ…å ±ä¿è­·æ³•ã«æº–æ‹ ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã« â€œåˆ©ç”¨å‰ã«åŒæ„â€ ã‚’æ˜ç¤ºã—ã¾ã™ã€‚

1. GA4 æ¸¬å®š ID ã‚’å–å¾—
Google Analytics â–¸ ç®¡ç† â–¸ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ

ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ âœ GA4

ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒªãƒ¼ãƒ â€¯â†’â€¯Web âœ æ¸¬å®š ID Gâ€‘XXXXXXXXXX

2. ç’°å¢ƒå¤‰æ•°ã«æ ¼ç´
.env

ini
ã‚³ãƒ”ãƒ¼ã™ã‚‹
ç·¨é›†ã™ã‚‹
PUBLIC_GA_ID=G-XXXXXXXXXX
3. BaseLayout ã« GA4 ã‚¹ãƒ‹ãƒšãƒƒãƒˆã‚’ã‚ªãƒ—ãƒˆã‚¤ãƒ³æ–¹å¼ã§æŒ¿å…¥
/src/layouts/BaseLayout.astro

astro
ã‚³ãƒ”ãƒ¼ã™ã‚‹
ç·¨é›†ã™ã‚‹
---
import CookieBar from "@/components/CookieBar.astro";
const GA_ID = import.meta.env.PUBLIC_GA_ID;
---
<html lang={locale.value}>
  <head>
    <!-- æ—¢å­˜ SeoHead ãªã© -->
    {GA_ID && (
      <>
        <script async src={`https://www.googletagmanager.com/gtag/js?id=${GA_ID}`}></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){{dataLayer.push(arguments);}}
          // åˆæœŸçŠ¶æ…‹: ã‚³ãƒ³ã‚»ãƒ³ãƒˆãŒå–ã‚Œã‚‹ã¾ã§ GA ã‚’ã‚ªãƒ•
          window.disable={GA_ID}=true;
        </script>
      </>
    )}
  </head>
  <body>
    <slot />
    <CookieBar gaId={GA_ID}/>
  </body>
</html>
4. æœ€å° CookieBar ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
/src/components/CookieBar.astro

astro
ã‚³ãƒ”ãƒ¼ã™ã‚‹
ç·¨é›†ã™ã‚‹
---
const { gaId } = Astro.props;
---
{gaId && (
  <div id="cookiebar" class="fixed bottom-4 inset-x-4 bg-gray-800 text-white p-4 rounded-xl shadow-lg flex flex-col md:flex-row items-center justify-between gap-4">
    <span>{t("cookie.message")}</span>
    <div class="flex gap-3">
      <a href="/legal/cookies" class="underline">{t("cookie.learn")}</a>
      <button class="btn btn-primary" on:click={accept}>{t("cookie.accept")}</button>
    </div>
  </div>
)}

<script>
function accept() {
  localStorage.setItem("cookie-consent","yes");
  document.getElementById("cookiebar").remove();
  // Enable GA after consent
  if(window.disable{gaId}!==undefined){ window["disable-"+gaId]=false; }
  gtag('js', new Date()); 
  gtag('config', '{gaId}', { 'anonymize_ip': true });
}
if(localStorage.getItem("cookie-consent")==="yes"){
  document.getElementById("cookiebar")?.remove();
}
</script>
i18n ã‚­ãƒ¼è¿½åŠ ï¼ˆcommon.jsonï¼‰
json
ã‚³ãƒ”ãƒ¼ã™ã‚‹
ç·¨é›†ã™ã‚‹
{
  "cookie.message": "We use cookies to improve your experience.",
  "cookie.learn": "Learn more",
  "cookie.accept": "Accept"
}
ï¼ˆå„è¨€èªãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚‚ç¿»è¨³ã‚’è¿½åŠ ï¼‰

5. A/B : å…ˆèª­ã¿ã‚¿ã‚°ã‚’ GA æœ‰åŠ¹æ™‚ã ã‘
astro
ã‚³ãƒ”ãƒ¼ã™ã‚‹
ç·¨é›†ã™ã‚‹
{localStorage.getItem("cookie-consent")==="yes" && (
  <link rel="preconnect" href="https://www.googletagmanager.com" />
)}
6. ãƒ†ã‚¹ãƒˆ
ãƒ†ã‚¹ãƒˆ	æœŸå¾…
åˆè¨ªå•	ãƒãƒŠãƒ¼ãŒè¡¨ç¤ºãƒ»GA ãƒ’ãƒƒãƒˆãªã— (Network ã§ collect?v=2 ãŒå‡ºãªã„)
ã€ŒAcceptã€ã‚¯ãƒªãƒƒã‚¯	ãƒãƒŠãƒ¼æ¶ˆãˆã‚‹ãƒ»GA ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡é–‹å§‹
å†èª­è¾¼	ãƒãƒŠãƒ¼éè¡¨ç¤ºãƒ»GA ç¶™ç¶š
Multiâ€‘lang	/ja/ ã§ã‚‚ç¿»è¨³ã•ã‚ŒãŸãƒãƒŠãƒ¼æ–‡ãŒå‡ºã‚‹
Lighthouse	A11y & Bestâ€‘Practices â‰¥â€¯90 ã‚’ç¶­æŒ

ä½œæ¥­å¾Œã«ã‚„ã‚‹ã“ã¨
GA4 Realtime ã§ãƒ’ãƒƒãƒˆç¢ºèª

legal/cookies ãƒšãƒ¼ã‚¸ã« Cookie ä½¿ç”¨ç›®çš„ã‚’è¿½è¨˜ï¼ˆæ—¢ã« Stepâ€¯5 ã§ç”Ÿæˆæ¸ˆã¿ï¼‰

å®Œäº†ã—ãŸã‚‰ã€ŒGA4 & Cookie OKã€ ã¨è¿”ä¿¡ã—ã¦ãã ã•ã„ã€‚
ãã®å¾Œ Stepâ€¯10 â€” æœ€çµ‚ QA & å…¬é–‹ãƒã‚§ãƒƒã‚¯ ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’ãŠæ¸¡ã—ã—ã¾ã™ã€‚